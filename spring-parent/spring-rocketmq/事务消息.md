### 事务消息原理

#### 问题场景
1. 向其他人转账100
2. 扣除自身账户金额
3. 发送消息，告诉另外一个人增减100

上面这个场景，如果在发送消息之前系统挂掉啦，消息没有来得及发送出去，此时自身已经扣钱，对方没有加钱。

#### 原理

1. 发送消息到mq，暂存还未确认真实发送
2. 处理自身金额扣除
3. 处理成功确认提交发送到mq，处理不成功确认失败不发送到mq
4. 如果一直未提交成功和失败，主动查询一下处理状态，如果是成功的提交消息到mq，不成功就不提交

### 代码实现

监听事务代码
```
@RocketMQTransactionListener(txProducerGroup = TX_PGROUP_NAME)
    class TransactionListenerImpl implements TransactionListener {

        @Override
        public LocalTransactionState executeLocalTransaction(Message msg, Object arg) {
            // 处理事务事情.........
            
            // 处理成功 提交消息
            return LocalTransactionState.COMMIT_MESSAGE;
             
            // 处理失败 回撤消息
            return LocalTransactionState.ROLLBACK_MESSAGE;

            // 未知处理，等待系统主动询问
            return LocalTransactionState.UNKNOW;
        }

        @Override
        public LocalTransactionState checkLocalTransaction(MessageExt msg) {
        
            // 一段时间未提交，或者提交UNKNOW 才会确认处理情况
            
             // 查询是成功的 提交消息
            return LocalTransactionState.COMMIT_MESSAGE;
             
            // 查询是失败的 回撤消息
            return LocalTransactionState.ROLLBACK_MESSAGE; 
        }
    }

```

发送事务消息
```
 org.apache.rocketmq.common.message.Message msg =
    new org.apache.rocketmq.common.message.Message(springTransTopic, tags[i % tags.length], "KEY" + i,
        ("Hello RocketMQxxxx " + i).getBytes(RemotingHelper.DEFAULT_CHARSET));
SendResult sendResult = rocketMQTemplate.sendMessageInTransaction(TX_PGROUP_NAME, msg, null);

```

> 两者通过 TX_PGROUP_NAME 关联在一起



